<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depi's Portal</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #fcf4f4; }
        .container { max-width: 450px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 5px solid #e63946; }
        h2 { text-align: center; color: #333; margin-bottom: 5px; }
        h4 { text-align: center; color: #666; margin-top: 0; margin-bottom: 20px; font-weight: normal; }
        .section { background: #fff0f1; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffe3e5; }
        label { font-weight: bold; margin-top: 10px; display: block; font-size: 14px;}
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin-top: 10px; background-color: #e63946; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #d62828; }
        #status { text-align: center; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>Depi's Portal ðŸ’Œ</h2>
    <h4>Send to Kostas</h4>
    
    <div class="section">
        <label>My Pager's Title (Updates YOUR screen):</label>
        <input type="text" id="myTitle" value="Depi Spiniara">

        <label>My Current City:</label>
        <input type="text" id="myCity" value="London">
    </div>

    <div class="section">
        <label>Message for Kostas:</label>
        <textarea id="messageBox" rows="4" placeholder="Type your message for him..."></textarea>
    </div>

    <button onclick="processAndSend()" id="sendBtn">Sync Settings & Send Message</button>

    <div id="status"></div>
</div>

<script>
    const myUrl = "https://love-pager-27704-default-rtdb.europe-west1.firebasedatabase.app/LovePagers/HerDevice.json";
    const hisUrl = "https://love-pager-27704-default-rtdb.europe-west1.firebasedatabase.app/LovePagers/HisDevice.json";

    async function getCoords(city) {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
        const data = await res.json();
        if(data.length > 0) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
        return null;
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return Math.round(R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))));
    }

    async function processAndSend() {
        const title = document.getElementById("myTitle").value;
        const city = document.getElementById("myCity").value;
        const msg = document.getElementById("messageBox").value;
        const statusDiv = document.getElementById("status");
        const btn = document.getElementById("sendBtn");

        if(msg.trim() === "" || city.trim() === "" || title.trim() === "") {
            statusDiv.style.color = "red"; statusDiv.innerText = "Please fill in all fields!"; return;
        }

        btn.disabled = true;
        statusDiv.style.color = "blue";
        statusDiv.innerText = "Locating Kostas & calculating distance...";

        try {
            // 1. Secretly peek at His database to find out what city he is in
            let hisCity = "Athens"; // Fallback just in case
            const peekRes = await fetch(hisUrl);
            const peekData = await peekRes.json();
            if(peekData && peekData.my_city) { hisCity = peekData.my_city; }

            // 2. Get GPS coords for both cities
            const loc1 = await getCoords(city);
            const loc2 = await getCoords(hisCity);

            if(!loc1 || !loc2) {
                statusDiv.style.color = "red"; statusDiv.innerText = "Could not find one of the cities!";
                btn.disabled = false; return;
            }

            // 3. Calculate Math
            const distanceKm = getDistance(loc1.lat, loc1.lon, loc2.lat, loc2.lon);
            statusDiv.innerText = `Distance: ${distanceKm} km. Sending...`;

            // 4. Update HER settings (Title, City, Distance)
            const myPayload = { pager_title: title, my_city: city, distance_km: distanceKm.toString() };
            await fetch(myUrl, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(myPayload) });

            // 5. Update HIS pager (Message, Distance, Alert)
            const hisPayload = { message: msg, distance_km: distanceKm.toString(), new_message_alert: true };
            await fetch(hisUrl, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(hisPayload) });

            statusDiv.style.color = "green";
            statusDiv.innerText = `Success! Sent to Kostas (${distanceKm}km away).`;
            document.getElementById("messageBox").value = ""; 
        } catch (error) {
            statusDiv.style.color = "red"; statusDiv.innerText = "Error syncing with pagers.";
        }
        btn.disabled = false;
    }
</script>
</body>
</html>
